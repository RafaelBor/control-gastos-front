<div class="reset-password-container">
  <mat-card class="reset-password-card">
    <div class="brand-section mt-3">
      <div class="brand-container">
        <h1 class="brand-title">
          Nueva <span class="brand-accent">Contraseña</span>
        </h1>
        <p class="brand-subtitle">
          Crea una contraseña segura para tu cuenta de MiauHORROS
        </p>
      </div>
    </div>

    <mat-card-content class="card-content">
      <!-- Token validation status -->
      @if (tokenStatus === 'validating') {
        <div class="validation-container">
          <mat-icon class="validation-icon spinning">refresh</mat-icon>
          <p class="validation-text">Validando enlace de recuperación...</p>
        </div>
      }

      @if (tokenStatus === 'invalid') {
        <div class="validation-container error">
          <mat-icon class="validation-icon">error</mat-icon>
          <div class="validation-content">
            <h3>Enlace inválido o expirado</h3>
            <p>Este enlace de recuperación no es válido o ha expirado. Por favor, solicita uno nuevo.</p>
            <button 
              [routerLink]="['/auth/forgot-password']" 
              mat-raised-button 
              class="retry-button">
              <mat-icon class="button-icon">refresh</mat-icon>
              Solicitar Nuevo Enlace
            </button>
          </div>
        </div>
      }

      @if (tokenStatus === 'valid') {
        <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()" class="reset-password-form">
          <!-- New Password field -->
          <div class="form-field">
            <mat-form-field appearance="outline" class="custom-form-field">
              <mat-label>Nueva Contraseña</mat-label>
              <mat-icon matPrefix class="field-icon">lock</mat-icon>
              <input 
                matInput 
                [type]="hideNewPassword ? 'password' : 'text'" 
                formControlName="newPassword" 
                placeholder="••••••••"
                autocomplete="new-password">
              <button 
                mat-icon-button 
                matSuffix 
                (click)="hideNewPassword = !hideNewPassword" 
                type="button"
                class="visibility-toggle"
                [attr.aria-label]="'Toggle password visibility'" 
                [attr.aria-pressed]="!hideNewPassword">
                <mat-icon>{{hideNewPassword ? 'visibility' : 'visibility_off'}}</mat-icon>
              </button>
              @if (resetPasswordForm.get('newPassword')?.hasError('required')) {
                <mat-error>La contraseña es requerida</mat-error>
              }
              @if (resetPasswordForm.get('newPassword')?.hasError('minlength')) {
                <mat-error>La contraseña debe tener al menos 8 caracteres</mat-error>
              }
              @if (resetPasswordForm.get('newPassword')?.hasError('pattern')) {
                <mat-error>La contraseña debe contener al menos una mayúscula, una minúscula y un número</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Confirm Password field -->
          <div class="form-field">
            <mat-form-field appearance="outline" class="custom-form-field">
              <mat-label>Confirmar Nueva Contraseña</mat-label>
              <mat-icon matPrefix class="field-icon">lock_outline</mat-icon>
              <input 
                matInput 
                [type]="hideConfirmPassword ? 'password' : 'text'" 
                formControlName="confirmPassword" 
                placeholder="••••••••"
                autocomplete="new-password">
              <button 
                mat-icon-button 
                matSuffix 
                (click)="hideConfirmPassword = !hideConfirmPassword" 
                type="button"
                class="visibility-toggle"
                [attr.aria-label]="'Toggle password visibility'" 
                [attr.aria-pressed]="!hideConfirmPassword">
                <mat-icon>{{hideConfirmPassword ? 'visibility' : 'visibility_off'}}</mat-icon>
              </button>
            </mat-form-field>
            
            @if (resetPasswordForm.hasError('passwordMismatch') && (resetPasswordForm.get('confirmPassword')?.touched || resetPasswordForm.get('confirmPassword')?.dirty)) {
              <p class="error-message">Las contraseñas no coinciden</p>
            }
          </div>

          <!-- Password strength indicator -->
          <div class="password-strength">
            <div class="strength-header">
              <span class="strength-label">Seguridad de la contraseña:</span>
              <span class="strength-level" [class]="getStrengthClass()">{{ getStrengthText() }}</span>
            </div>
            <div class="strength-bar">
              <div class="strength-fill" [class]="getStrengthClass()" [style.width.%]="passwordStrength"></div>
            </div>
            <div class="strength-requirements">
              <div class="requirement" [class.met]="hasMinLength">
                <mat-icon class="requirement-icon">{{ hasMinLength ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                <span>Al menos 8 caracteres</span>
              </div>
              <div class="requirement" [class.met]="hasUppercase">
                <mat-icon class="requirement-icon">{{ hasUppercase ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                <span>Una letra mayúscula</span>
              </div>
              <div class="requirement" [class.met]="hasLowercase">
                <mat-icon class="requirement-icon">{{ hasLowercase ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                <span>Una letra minúscula</span>
              </div>
              <div class="requirement" [class.met]="hasNumber">
                <mat-icon class="requirement-icon">{{ hasNumber ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                <span>Un número</span>
              </div>
            </div>
          </div>

          <!-- Messages -->
          @if (errorMessage) {
            <div class="message-container error-container">
              <mat-icon class="message-icon">error</mat-icon>
              <p class="error-message">{{ errorMessage }}</p>
            </div>
          }

          @if (successMessage) {
            <div class="message-container success-container">
              <mat-icon class="message-icon">check_circle</mat-icon>
              <p class="success-message">{{ successMessage }}</p>
            </div>
          }

          <!-- Reset password button -->
          <div class="form-field">
            <button 
              mat-raised-button 
              type="submit"
              [disabled]="!resetPasswordForm.valid || isLoading"
              class="reset-button">
              @if (isLoading) {
                <mat-icon class="button-icon spinning">refresh</mat-icon>
                Actualizando...
              } @else {
                <mat-icon class="button-icon">security</mat-icon>
                Actualizar Contraseña
              }
            </button>
          </div>

          <!-- Security tips -->
          <div class="security-tips">
            <div class="tips-header">
              <mat-icon class="tips-icon">tips_and_updates</mat-icon>
              <span>Consejos de seguridad</span>
            </div>
            <ul class="tips-list">
              <li>Usa una combinación de letras, números y símbolos</li>
              <li>Evita información personal como nombres o fechas</li>
              <li>No reutilices contraseñas de otras cuentas</li>
              <li>Considera usar un gestor de contraseñas</li>
            </ul>
          </div>

          <!-- Back to login button -->
          <div class="form-field">
            <button 
              [routerLink]="['/auth/login']" 
              mat-stroked-button 
              class="back-button">
              <mat-icon class="button-icon">arrow_back</mat-icon>
              Volver al Login
            </button>
          </div>
        </form>
      }
    </mat-card-content>
  </mat-card>
</div>

